<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home WebAR — 8th Wall + A-Frame</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- 8th Wall A-Frame build ("8-Frame") -->
  <script src="//cdn.8thwall.com/web/aframe/8frame-1.4.1.min.js"></script>

  
  <!-- 8th Wall Extras (loading screen, “almost there” prompts, runtime error UI) -->
  <script defer src="//cdn.8thwall.com/web/xrextras/xrextras.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:transparent; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .ui { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.8); color:#fff; z-index:10; }
    .ui.hidden { display:none; }
    .btn { appearance:none; border:0; border-radius:10px; padding:14px 22px; font-weight:600; cursor:pointer; background:#1976d2; color:#fff; }
  </style>

  <!-- Simple fragment shader to combine color + alpha videos -->
  <script id="matte-frag" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D videoColor;
    uniform sampler2D videoAlpha;
    uniform float opacity;
    varying vec2 vUV;
    void main() {
      vec4 c = texture2D(videoColor, vUV);
      float a = texture2D(videoAlpha, vUV).r * opacity;
      gl_FragColor = vec4(c.rgb, a);
    }
  </script>
  <script id="matte-vert" type="x-shader/x-vertex">
    varying vec2 vUV;
    void main() {
      vUV = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  </script>
</head>
<body>
  <!-- “Start AR” overlay (required user gesture) -->
  <div id="gate" class="ui">
    <div style="text-align:center">
      <div style="font-size:18px;margin-bottom:10px">Back Home AR</div>
      <div style="opacity:.85;margin-bottom:16px">This will request camera access</div>
      <button id="startBtn" class="btn">Start AR</button>
    </div>
  </div>

  <!-- A-Frame scene bootstrapped by 8th Wall -->
  <a-scene
    xrweb                       <!-- turns on camera + SLAM -->
    xrextras-almost-there       <!-- device support UI -->
    xrextras-loading            <!-- loading UI -->
    xrextras-runtime-error      <!-- error UI -->
    renderer="alpha:true; physicallyCorrectLights:true; colorManagement:true"
    embedded
  >
    <a-assets>
      <!-- Your videos -->
      <video id="videoColor" src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             preload="auto" loop muted crossorigin="anonymous" playsinline webkit-playsinline></video>
      <video id="videoAlpha" src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             preload="auto" loop muted crossorigin="anonymous" playsinline webkit-playsinline></video>
    </a-assets>

    <!-- Soft light so the plane isn’t too dark -->
    <a-entity light="type:ambient; intensity:1"></a-entity>

    <!-- Video plane: starts hidden; we’ll show + play after session begins -->
    <a-plane id="videoPlane"
      width="0.85" height="0.67"
      position="0 1.3 -1" rotation="-15 0 0"
      material="shader: video-matte; videoColor:#videoColor; videoAlpha:#videoAlpha; transparent:true; opacity:1; alphaTest:0.1"
      visible="false">
    </a-plane>

    <!-- Camera w/ mouse cursor so you can test on desktop too -->
    <a-entity id="cameraRig">
      <a-camera
        position="0 1.6 0"
        raycaster="objects: .cantap"
        cursor="rayOrigin: mouse; fuse: false">
      </a-camera>
    </a-entity>
  </a-scene>

  <script>
    // Register the matte shader in A-Frame
    AFRAME.registerShader('video-matte', {
      schema: {
        videoColor: { type: 'map', is: 'uniform' },
        videoAlpha: { type: 'map', is: 'uniform' },
        opacity:    { type: 'number', default: 1.0, is: 'uniform' }
      },
      fragmentShader: document.getElementById('matte-frag').textContent,
      vertexShader:   document.getElementById('matte-vert').textContent
    });

    const gate       = document.getElementById('gate');
    const startBtn   = document.getElementById('startBtn');
    const videoPlane = document.getElementById('videoPlane');
    const videoColor = document.getElementById('videoColor');
    const videoAlpha = document.getElementById('videoAlpha');

    // Delay engine init until user taps the button (recommended pattern)
    startBtn.addEventListener('click', () => {
      gate.classList.add('hidden');

      if (videoColor) { videoColor.play().catch(()=>{}); }
      if (videoAlpha) { videoAlpha.play().catch(()=>{}); }
    });

    // When 8th Wall’s A-Frame scene is ready, show your content and ensure transparency
    document.querySelector('a-scene').addEventListener('loaded', () => {
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('enter-vr', () => {
        // Transparent canvas in AR
        sceneEl.renderer.setClearColor(0x000000, 0);
        sceneEl.renderer.domElement.style.background = 'transparent';
      });

      // As soon as the camera feed is running, show + play the videos
      window.addEventListener('xrextrasloaded', () => {
        videoPlane.setAttribute('visible', true);
        videoColor.play().catch(()=>{});
        videoAlpha.play().catch(()=>{});
      });
    });
  </script>
</body>
</html>
