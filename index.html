<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” MindAR Stable Video</title>

  <!-- A-Frame and MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/aframe/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: transparent;
    }

    #soundOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      color: #fff;
      z-index: 9999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    #soundOverlay button {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 18px;
      font-weight: bold;
      font-size: 16px;
    }
  </style>

  <!-- Custom Shader: Color + Alpha blending -->
  <script>
    AFRAME.registerShader('video-matte', {
      schema: {
        videoColor: { type: 'map', is: 'uniform' },
        videoAlpha: { type: 'map', is: 'uniform' },
        opacity: { type: 'number', default: 1, is: 'uniform' }
      },
      vertexShader: `
        varying vec2 vUV;
        void main() {
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        precision highp float;
        varying vec2 vUV;
        uniform sampler2D videoColor;
        uniform sampler2D videoAlpha;
        uniform float opacity;
        void main() {
          vec4 color = texture2D(videoColor, vUV);
          float alpha = texture2D(videoAlpha, vUV).r;
          alpha = smoothstep(0.15, 0.95, alpha) * opacity;
          gl_FragColor = vec4(color.rgb, alpha);
        }
      `
    });
  </script>
</head>

<body>
  <!-- Tap to enable audio -->
  <div id="soundOverlay">
    <div style="text-align:center">
      <p style="margin-bottom:10px;font-size:18px">Tap to enable sound ðŸ”Š</p>
      <button id="soundBtn">Enable Audio</button>
    </div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: https://raw.githubusercontent.com/alevalve/AR_Crab_Backhome/main/targets.mind; autoStart: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: true"
    renderer="colorManagement: true, physicallyCorrectLights"
    embedded
  >
    <a-assets>
      <!-- Color and Alpha videos -->
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <!-- MindAR target (index 0 = first marker in targets.mind) -->
    <a-entity mindar-image-target="targetIndex: 0">
      <a-plane
        id="videoPlane"
        width="1.2"
        height="0.67"
        rotation="-90 0 0"
        material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; transparent: true; depthWrite: false"
        position="0 0 0"
      ></a-plane>
    </a-entity>

    <!-- Camera -->
    <a-camera look-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    const overlay = document.getElementById('soundOverlay');
    const btn = document.getElementById('soundBtn');
    const vc = document.getElementById('videoColor');
    const va = document.getElementById('videoAlpha');

    // Attempt autoplay (muted)
    Promise.allSettled([vc.play(), va.play()]);

    // Unlock audio on tap
    btn.addEventListener('click', () => {
      vc.muted = false;
      vc.currentTime = 0;
      va.currentTime = 0;
      vc.play();
      va.play();
      overlay.style.display = 'none';
    });
  </script>
</body>
</html>
