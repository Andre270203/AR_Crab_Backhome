<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Back Home AR — Fit to Marker Size</title>

  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body{margin:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
    .loader,.gate{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
    .loader{background:rgba(0,0,0,.85);color:#fff}
    .gate{background:rgba(0,0,0,.55);color:#fff;z-index:10000}
    .gate[hidden]{display:none}
    .btn{margin-top:12px;background:#4caf50;color:#fff;border:0;border-radius:20px;padding:10px 18px;font-weight:700;cursor:pointer}
    .debug{position:absolute;top:8px;left:8px;z-index:10001;background:rgba(0,0,0,.75);color:#fff;padding:6px 8px;border-radius:6px;font-size:12px}
  </style>

  <script>
    const $ = sel => document.querySelector(sel);

    // Smooth position & rotation
    AFRAME.registerComponent('smooth', {
      schema:{pos:{default:0.18},rot:{default:0.18}},
      init(){const o=this.el.object3D; this._p=o.position.clone(); this._q=o.quaternion.clone();},
      tick(){const o=this.el.object3D; this._p.lerp(o.position,this.data.pos); o.position.copy(this._p);
             this._q.slerp(o.quaternion,this.data.rot); o.quaternion.copy(this._q);}
    });

    // Fit plane to the physical width of the detected image (meters)
    AFRAME.registerComponent('fit-video-plane', {
      schema:{
        target:{type:'selector'},     // #videoColor
        markerWidth:{default:0.18},   // meters -> set this to your print width!
        fitBy:{default:'width'},      // 'width' | 'height'
        padding:{default:0.0}         // meters trimmed on each side
      },
      init(){
        const plane=this.el, vid=this.data.target;
        const apply=()=>{
          const vw=vid.videoWidth||16, vh=vid.videoHeight||9, asp=vw/vh;
          let width,height;
          if(this.data.fitBy==='height'){
            height=this.data.markerWidth - (this.data.padding*2);
            width =height*asp;
          }else{
            width =this.data.markerWidth - (this.data.padding*2);
            height=width/asp;
          }
          plane.setAttribute('geometry',`primitive: plane; width: ${width}; height: ${height}`);
        };
        if(vid){
          vid.addEventListener('loadedmetadata',apply);
          if(vid.readyState>=1) apply();
        }
      }
    });

    // Audio gate + immediate unmute on detection + loss grace
    AFRAME.registerComponent('ar-video', {
      schema:{
        plane:{type:'selector'},
        confirmMs:{default:0},   // 0 = start audio immediately when found
        lostMs:{default:900}
      },
      init(){
        this.color=$('#videoColor'); this.alpha=$('#videoAlpha'); this.plane=this.data.plane;
        this.gate=$('#gate'); this.btn=$('#enableBtn');
        this.debug=msg=>{const d=$('#debug'); if(d) d.textContent=msg;};

        // Start muted to satisfy autoplay policies
        [this.color,this.alpha].forEach(v=>{v.muted=true; v.volume=0; v.setAttribute('muted','');});

        // Prevent rare culling pops
        this.plane.object3D.traverse(n=>n.frustumCulled=false);

        // Arm audio with one explicit tap (no sound yet)
        this.armed=false; this.live=false; this.ct=null; this.lt=null;
        this.btn.addEventListener('click', async ()=>{
          try{
            await Promise.allSettled([this.color.play(), this.alpha.play()]); // prime decoding muted
            this.color.muted=true; this.color.volume=0;
            this.armed=true; this.gate.hidden=true;
            this.debug('Audio armed. Waiting for marker…');
          }catch{ this.debug('Tap again to arm audio'); }
        },{once:true});
        this.gate.hidden=false;

        const startAudio = async ()=>{
          if(this.armed && !this.live){
            try{ this.color.muted=false; this.color.volume=1; await this.color.play(); this.live=true; this.debug('Audio ON'); }
            catch(e){ this.live=false; this.gate.hidden=false; this.debug('Tap to enable audio'); }
          }
        };

        // Marker events
        this.el.addEventListener('markerFound', ()=>{
          this.debug('Marker found');
          if(this.lt){clearTimeout(this.lt); this.lt=null;}
          if(this.color.paused) this.color.play().catch(()=>{});
          if(this.alpha.paused) this.alpha.play().catch(()=>{});
          if(this.ct){clearTimeout(this.ct); this.ct=null;}
          if(this.data.confirmMs<=0){ startAudio(); }
          else { this.ct=setTimeout(startAudio,this.data.confirmMs); }
        });

        this.el.addEventListener('markerLost', ()=>{
          this.debug('Marker lost (grace…)');
          if(this.ct){clearTimeout(this.ct); this.ct=null;}
          if(this.lt) clearTimeout(this.lt);
          this.lt=setTimeout(()=>{
            this.live=false; this.color.muted=true; this.color.volume=0;
            if(!this.color.paused) this.color.pause();
            if(!this.alpha.paused) this.alpha.pause();
            this.debug('Paused after grace');
          }, this.data.lostMs);
        });
      }
    });
  </script>
</head>

<body>
  <div class="loader" id="loader"><div>Loading, please wait…</div></div>

  <!-- One tap to ARM audio; sound starts when the marker is detected -->
  <div class="gate" id="gate" hidden>
    <div>
      <div>Tap once to arm audio. Sound starts on detection.</div>
      <button class="btn" id="enableBtn">Arm Audio</button>
    </div>
  </div>
  <div class="debug" id="debug">Init…</div>

  <a-scene
    vr-mode-ui="enabled: false;"
    renderer="antialias: true; logarithmicDepthBuffer: true; precision: high;"
    embedded
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;
          maxDetectionRate: 60; canvasWidth: 1280; canvasHeight: 960;"
  >
    <a-assets timeout="3000">
      <video id="videoColor" src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             preload="metadata" loop muted crossorigin="anonymous" webkit-playsinline playsinline></video>
      <video id="videoAlpha" src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             preload="metadata" loop muted crossorigin="anonymous" webkit-playsinline playsinline></video>
    </a-assets>

    <!-- Matte shader -->
    <script id="matte-shader" type="x-shader/x-fragment">
      precision mediump float;
      uniform sampler2D videoColor; uniform sampler2D videoAlpha; varying vec2 vUV;
      void main(){ vec4 c=texture2D(videoColor,vUV); vec4 a=texture2D(videoAlpha,vUV);
                   gl_FragColor=vec4(c.rgb,a.r); }
    </script>
    <script>
      AFRAME.registerShader('video-matte-shader',{
        schema:{videoColor:{type:'map',is:'uniform'},videoAlpha:{type:'map',is:'uniform'}},
        fragmentShader:document.getElementById('matte-shader').textContent,
        vertexShader:'varying vec2 vUV; void main(){ vUV=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }'
      });
    </script>

    <!-- IMPORTANT: url points to the NFT dataset ROOT (no extension) -->
    <a-nft
      ar-video="plane:#videoPlane; confirmMs:0; lostMs:900"
      type="nft"
      url="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/marker/AR_Image-tracker_Crab"
      smooth="true" smoothCount="30" smoothTolerance="0.01" smoothThreshold="10"
    >
      <!-- Set markerWidth to your printed image width (meters). Example: 0.18 = 18 cm -->
      <a-entity id="videoPlane"
        smooth="pos:0.18; rot:0.18"
        fit-video-plane="target:#videoColor; markerWidth:0.18; fitBy:width; padding:0.003"
        geometry="primitive: plane; width: 0.18; height: 0.1"  <!-- will be overridden by fit-video-plane -->
        material="shader: video-matte-shader; videoColor:#videoColor; videoAlpha:#videoAlpha; transparent:true; alphaTest:0.1;"
        position="0 0 0.005" rotation="-90 0 0">
      </a-entity>
    </a-nft>

    <a-entity camera look-controls position="0 1.6 0"></a-entity>
  </a-scene>

  <!-- Robust, tiny loader hider -->
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const loader=$('#loader'), scene=$('a-scene');
      const hide=()=>{ if(loader) loader.style.display='none'; };
      ['loaded','renderstart','arReady','camera-init'].forEach(ev=>scene.addEventListener(ev,hide));
      window.addEventListener('arjs-video-loaded', hide);
      scene.addEventListener('markerFound', hide);
      setTimeout(hide, 7000);
    });
  </script>
</body>
</html>
