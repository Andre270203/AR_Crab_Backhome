<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ARnft - Video Color calibrado al marcador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1" />
  </head>
  <body>
    <!-- Video color -->
    <video id="videoColor" loop muted playsinline webkit-playsinline crossorigin="anonymous">
      <source src="https://raw.githack.com/Andre270203/AR_Crab_Backhome/main/AR_Video02_Color.mp4" type="video/mp4" />
    </video>

    <script type="importmap">
      {
        "imports": {
          "three": "./js/third_party/three.js/three.module.min.js",
          "arnft-threejs": "./js/ARnftThreejs.module.js",
          "arnft": "./../dist/ARnft.module.js"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import arnft from "arnft";
      const { ARnft } = arnft;
      import ARnftThreejs from "arnft-threejs";
      const { SceneRendererTJS, NFTaddTJS } = ARnftThreejs;

      let width = 640;
      let height = 480;

      // Inicializar ARnft con tu marcador
      ARnft.init(
        width,
        height,
        [["marker/AR_Image-tracker_Crab"]], // Ruta a los datos (.fset, .iset, .fset3)
        [["AR_Image-tracker_Crab"]],        // Nombre del marcador
        "config.json",
        true
      )
      .then((nft) => {
        document.addEventListener("containerEvent", function () {
          let canvas = document.getElementById("canvas");
          let fov = (0.8 * 180) / Math.PI;
          let ratio = width / height;

          let config = {
            renderer: { alpha: true, antialias: true, precision: "mediump" },
            camera: { fov: fov, ratio: ratio, near: 0.01, far: 1000 }
          };

          // Crear la escena
          let sceneThreejs = new SceneRendererTJS(config, canvas, nft.uuid, true);
          sceneThreejs.initRenderer();

          let nftAddTJS = new NFTaddTJS(nft.uuid);

          // Crear textura del video
          const videoColor = document.getElementById("videoColor");
          videoColor.play();
          const texColor = new THREE.VideoTexture(videoColor);

          // Material básico con el video
          const material = new THREE.MeshBasicMaterial({ map: texColor, side: THREE.DoubleSide });

          // Plano ajustado a las dimensiones reales del marcador (27.5cm × 18cm)
          let geometry = new THREE.PlaneGeometry(0.275, 0.18);
          let plane = new THREE.Mesh(geometry, material);

          // Añadir el plano al marcador
          nftAddTJS.add(plane, "AR_Image-tracker_Crab");

          // Render loop
          const tick = () => {
            sceneThreejs.draw();
            requestAnimationFrame(tick);
          };
          tick();
        });
      })
      .catch((error) => console.log(error));
    </script>
  </body>
</html>
