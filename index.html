<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Back Home AR Experience — Variant/WebXR</title>

  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .arjs-loader {
      height: 100%; width: 100%; position: absolute; top: 0; left: 0;
      background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center;
      color: #fff; font-size: 1.1em;
    }
    .audio-status {
      position: absolute; bottom: 16px; right: 16px; z-index: 10001;
      background: rgba(0,0,0,0.8); color: #fff; padding: 8px 12px;
      border-radius: 20px; font-size: 12px; display: none;
    }
    .tap-overlay {
      position: absolute; inset: 0; display: none; z-index: 10000;
      background: rgba(0,0,0,0.55); color: #fff; font-weight: 700;
      align-items: center; justify-content: center; text-align: center; padding: 24px;
    }
    .tap-btn {
      margin-top: 12px; background: #4caf50; color: #fff; border: 0; border-radius: 20px; padding: 10px 18px; font-weight: 700;
    }
    .sound-chip {
      position: absolute; left: 50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff; padding: 8px 12px; border-radius: 999px; font-size: 14px; z-index: 10001; display: none;
    }
    /* Optional custom Enter AR button */
    .enter-ar {
      position: fixed; right: 16px; bottom: 16px; z-index: 10002;
      padding: 10px 16px; border-radius: 999px; border: 0; font-weight: 700;
      background: #1976d2; color: #fff;
    }
  </style>

  <!-- Fragment shader (alpha matte from second video) -->
  <script id="matte-shader" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D videoColor;
    uniform sampler2D videoAlpha;
    uniform float opacity;
    varying vec2 vUV;
    void main() {
      vec4 color = texture2D(videoColor, vUV);
      vec4 alpha = texture2D(videoAlpha, vUV);
      float a = alpha.r * opacity;
      gl_FragColor = vec4(color.rgb, a);
    }
  </script>

  <script>
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);

    // Shader registration for A-Frame
    AFRAME.registerShader('enhanced-video-matte-shader', {
      schema: {
        videoColor: { type: 'map', is: 'uniform' },
        videoAlpha: { type: 'map', is: 'uniform' },
        opacity: { type: 'number', default: 1.0, is: 'uniform' }
      },
      fragmentShader: document.getElementById('matte-shader').textContent,
      vertexShader: `
        precision mediump float;
        varying vec2 vUV;
        void main() {
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `
    });

    // Smooth transform (optional mild stabilization)
    AFRAME.registerComponent('smooth-transform', {
      schema: { factor: {type: 'number', default: 0.2 } },
      init: function () {
        this.lastPos = new THREE.Vector3();
        this.lastRot = new THREE.Euler();
      },
      tick: function () {
        if (!this.el.object3D.visible) return;
        const f = this.data.factor;
        const pos = this.el.object3D.position;
        const rot = this.el.object3D.rotation;
        this.lastPos.lerp(pos, f); pos.copy(this.lastPos);
        this.lastRot.x += (rot.x - this.lastRot.x) * f;
        this.lastRot.y += (rot.y - this.lastRot.y) * f;
        this.lastRot.z += (rot.z - this.lastRot.z) * f;
        rot.copy(this.lastRot);
      }
    });

    // Hit-test placement (replaces AR.js <a-nft>)
    AFRAME.registerComponent('place-on-tap', {
      schema: {
        followUntilPlaced: { type: 'boolean', default: true }
      },
      init() {
        this.placed = false;
        this.xrSession = null;
        this.refSpace = null;
        this.hitTestSource = null;
        this.frame = null;

        // Reticle
        this.reticle = document.createElement('a-ring');
        this.reticle.setAttribute('radius-inner', '0.035');
        this.reticle.setAttribute('radius-outer', '0.055');
        this.reticle.setAttribute('color', '#FFFFFF');
        this.reticle.setAttribute('rotation', '-90 0 0');
        this.reticle.setAttribute('visible', 'false');
        this.el.sceneEl.appendChild(this.reticle);

        // Start when AR session begins
        this.onSessionStart = () => {
          const r = this.el.sceneEl.renderer;
          this.xrSession = r.xr.getSession();
          if (!this.xrSession) return;

          Promise.all([
            this.xrSession.requestReferenceSpace('local'),
            this.xrSession.requestReferenceSpace('viewer')
          ]).then(([localRef, viewerRef]) => {
            this.refSpace = localRef;
            return this.xrSession.requestHitTestSource({ space: viewerRef });
          }).then((source) => {
            this.hitTestSource = source;
          }).catch(console.warn);

          // Allow first tap to place
          this.onFirstTap = () => { 
            if (!this.placed) this.placed = true; 
            window.removeEventListener('click', this.onFirstTap);
            this.el.emit('content-placed'); // notify other components (e.g., video player)
          };
          window.addEventListener('click', this.onFirstTap, { once: true });
        };

        // Cleanup on end
        this.onSessionEnd = () => {
          this.xrSession = null;
          this.hitTestSource = null;
          this.refSpace = null;
          this.reticle.setAttribute('visible', 'false');
        };

        this.el.sceneEl.renderer.xr.addEventListener('sessionstart', this.onSessionStart);
        this.el.sceneEl.renderer.xr.addEventListener('sessionend', this.onSessionEnd);

        // Per-frame loop to update reticle & follow
        this.el.sceneEl.renderer.setAnimationLoop((t, frame) => {
          if (!frame || !this.hitTestSource || !this.refSpace) return;
          const results = frame.getHitTestResults(this.hitTestSource);
          if (results.length > 0) {
            const pose = results[0].getPose(this.refSpace);
            const p = pose.transform.position;
            const q = pose.transform.orientation;

            this.reticle.object3D.position.set(p.x, p.y, p.z);
            this.reticle.object3D.quaternion.set(q.x, q.y, q.z, q.w);
            this.reticle.setAttribute('visible', !this.placed);

            if (this.data.followUntilPlaced && !this.placed) {
              this.el.object3D.position.copy(this.reticle.object3D.position);
              this.el.object3D.quaternion.copy(this.reticle.object3D.quaternion);
            }
          }
        });
      },
      remove() {
        this.el.sceneEl.renderer.xr.removeEventListener('sessionstart', this.onSessionStart);
        this.el.sceneEl.renderer.xr.removeEventListener('sessionend', this.onSessionEnd);
        if (this.reticle && this.reticle.parentNode) this.reticle.parentNode.removeChild(this.reticle);
      }
    });

    // Adaptive video player (no marker; driven by session + placement + audio unlock)
    AFRAME.registerComponent('adaptive-videoplayer', {
      schema: {
        volume: { type: 'number', default: 0.8 }
      },
      init: function () {
        this.videoColor = document.querySelector('#videoColor');
        this.videoAlpha = document.querySelector('#videoAlpha');
        this.audioStatus = document.getElementById('audioStatus');
        this.tapOverlay = document.getElementById('tapOverlay');
        this.tapBtn = document.getElementById('tapBtn');
        this.soundChip = document.getElementById('soundChip');

        // Start muted
        this.videoColor.muted = true;
        this.videoAlpha.muted = true;
        this.videoColor.volume = this.data.volume;
        this.videoAlpha.volume = 0;

        this.audioUnlocked = false;
        this.placed = false;

        // Platform UI
        if (isIOS) {
          this.tapOverlay.style.display = 'flex';
        } else if (isAndroid) {
          this.soundChip.style.display = 'block';
        }

        const enableAudio = () => {
          this.audioUnlocked = true;
          this.tapOverlay.style.display = 'none';
          this.soundChip.style.display = 'none';
          this.updatePlayback();
        };

        this.tapBtn.addEventListener('click', enableAudio, { once: true });
        this.tapOverlay.addEventListener('click', enableAudio, { once: true });
        this.soundChip.addEventListener('click', enableAudio, { once: true });
        window.addEventListener('touchend', () => {
          if (!this.audioUnlocked && (isIOS || isAndroid)) enableAudio();
        }, { passive: true, once: true });

        // React to “content-placed” from place-on-tap
        this.el.addEventListener('content-placed', () => {
          this.placed = true;
          this.updatePlayback();
        });

        // Pause on page hide
        document.addEventListener('visibilitychange', () => {
          if (document.hidden) this.stopVideos();
          else this.updatePlayback();
        });

        // Also listen for session start/end to manage audio UI
        const xr = this.el.sceneEl.renderer.xr;
        xr.addEventListener('sessionstart', () => this.updatePlayback());
        xr.addEventListener('sessionend', () => { this.stopVideos(); this.audioStatus.style.display = 'none'; });
      },

      updatePlayback() {
        // Play only if placed and session is active
        const inAR = this.el.sceneEl.is('ar-mode');
        const shouldPlay = inAR && this.placed;

        if (!shouldPlay) { this.stopVideos(); return; }

        if (this.audioUnlocked) {
          this.videoColor.muted = false;
          this.audioStatus.style.display = 'block';
          this.audioStatus.textContent = '🔊 Audio ON';
        } else {
          this.videoColor.muted = true;
          this.audioStatus.style.display = 'block';
          this.audioStatus.textContent = '🔇 Audio OFF — Tap to enable';
        }

        // Try to play both streams
        this.videoColor.play().catch(e => console.log('Color video play failed:', e));
        this.videoAlpha.play().catch(e => console.log('Alpha video play failed:', e));
      },

      stopVideos() {
        if (!this.videoColor.paused) this.videoColor.pause();
        if (!this.videoAlpha.paused) this.videoAlpha.pause();
      }
    });
  </script>
</head>

<body style="margin: 0; overflow: hidden;">
  <div class="arjs-loader" id="loader"><div>Loading, please wait…</div></div>

  <div class="audio-status" id="audioStatus">🔇 Audio OFF</div>

  <div class="tap-overlay" id="tapOverlay">
    <div>
      <div>Tap to enable video & audio<br><small>Audio will play after placement</small></div>
      <button class="tap-btn" id="tapBtn">Enable</button>
    </div>
  </div>

  <div class="sound-chip" id="soundChip">🔊 Tap to enable sound</div>

  <button class="enter-ar" id="enterAR">Enter AR</button>

  <a-scene
    renderer="logarithmicDepthBuffer: true; precision: medium; antialias: true;"
    webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #tapOverlay"
    vr-mode-ui="enabled: false"
    embedded
    onloaded="document.getElementById('loader').style.display='none';"
  >
    <a-assets>
      <!-- Keep your hosted videos -->
      <video
        id="videoColor"
        src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
        preload="metadata"
        loop
        muted
        crossorigin="anonymous"
        webkit-playsinline
        playsinline
      ></video>

      <video
        id="videoAlpha"
        src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
        preload="metadata"
        loop
        muted
        crossorigin="anonymous"
        webkit-playsinline
        playsinline
      ></video>
    </a-assets>

    <!-- Content root: follows reticle until first tap, then locks -->
    <a-entity place-on-tap smooth-transform adaptive-videoplayer>
      <!-- Plane sized for mobile AR (~meters). Adjust to taste. -->
      <a-entity
        geometry="primitive: plane; width: 1.25; height: 0.67"
        material="shader: enhanced-video-matte-shader;
                  videoColor: #videoColor;
                  videoAlpha: #videoAlpha;
                  opacity: 1.0;
                  transparent: true;
                  alphaTest: 0.1;"
        position="0 0 0"
        rotation="-90 0 0"
      ></a-entity>
    </a-entity>

    <!-- Camera -->
    <a-entity 
      camera 
      look-controls="enabled: true; reverseMouseDrag: true; touchEnabled: true; magicWindowTrackingEnabled: true"
      wasd-controls="enabled: false"
      position="0 1.6 0"
    ></a-entity>
  </a-scene>

  <script>
    // Optional custom "Enter AR" button (triggers A-Frame's AR entry)
    const enterBtn = document.getElementById('enterAR');
    enterBtn.addEventListener('click', () => {
      const scene = document.querySelector('a-scene');
      if (scene && scene.enterVR) scene.enterVR(); // enters AR if available
    });
  </script>
</body>
</html>
