<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” Stable Marker-Fixed Video</title>

  <!-- A-Frame + AR.js for NFT markers -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; background: transparent; }
    #soundOverlay {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.6); color: #fff; z-index: 9999;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    #soundOverlay button {
      background: #1976d2; color: #fff; border: none;
      border-radius: 10px; padding: 12px 18px;
      font-weight: bold; font-size: 16px;
    }
  </style>

  <!-- Matte Shader -->
  <script>
    AFRAME.registerShader('video-matte', {
      schema: {
        videoColor: { type: 'map', is: 'uniform' },
        videoAlpha: { type: 'map', is: 'uniform' },
        opacity: { type: 'number', default: 1, is: 'uniform' }
      },
      vertexShader: `
        varying vec2 vUV;
        void main() {
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,
      fragmentShader: `
        precision highp float;
        varying vec2 vUV;
        uniform sampler2D videoColor;
        uniform sampler2D videoAlpha;
        uniform float opacity;
        void main() {
          vec4 color = texture2D(videoColor, vUV);
          float alpha = texture2D(videoAlpha, vUV).r;
          alpha = smoothstep(0.15, 0.95, alpha) * opacity;
          gl_FragColor = vec4(color.rgb, alpha);
        }
      `
    });
  </script>
</head>

<body>
  <!-- Mobile Audio Unlock -->
  <div id="soundOverlay">
    <div style="text-align:center">
      <p style="margin-bottom:10px;font-size:18px">Tap to enable sound ðŸ”Š</p>
      <button id="soundBtn">Enable Audio</button>
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="antialias: true; alpha: true; precision: medium"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false"
  >
    <a-assets>
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <!-- NFT Marker: Smoothing + Events -->
    <a-nft
      type="nft"
      url="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/marker/AR_Image-tracker_Crab"
      emitevents="true"
      smooth="true"
      smoothCount="100"
      smoothTolerance="0.01"
      smoothThreshold="10"
    >
      <!-- Video Plane: Locked to marker -->
      <a-entity id="videoPlane"
        geometry="primitive: plane; width: 1.2; height: 0.67"
        material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; transparent: true; depthWrite: false"
        position="0 0 0.1"
        rotation="-90 0 0"
        visible="false"
      ></a-entity>
    </a-nft>

    <a-entity camera look-controls="enabled: false"></a-entity>
  </a-scene>

  <script>
    const overlay = document.getElementById('soundOverlay');
    const btn = document.getElementById('soundBtn');
    const vc = document.getElementById('videoColor');
    const va = document.getElementById('videoAlpha');
    const marker = document.querySelector('a-nft');
    const videoPlane = document.getElementById('videoPlane');

    // Try autoplay silently (mobile-safe)
    Promise.allSettled([vc.play(), va.play()]);

    // Audio unlock
    btn.addEventListener('click', () => {
      vc.muted = false;
      vc.currentTime = 0;
      va.currentTime = 0;
      vc.play();
      va.play();
      overlay.style.display = 'none';
    });

    // Custom visibility logic to avoid flicker
    let lostTimeout = null;

    marker.addEventListener('markerFound', () => {
      clearTimeout(lostTimeout);
      videoPlane.setAttribute('visible', true);
    });

    marker.addEventListener('markerLost', () => {
      // Delay hide to avoid flicker from quick re-detect
      lostTimeout = setTimeout(() => {
        videoPlane.setAttribute('visible', false);
      }, 600); // adjust delay as needed
    });
  </script>
</body>
</html>
