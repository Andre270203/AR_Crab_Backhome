<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” Fixed Version</title>
  
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  
  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      overflow: hidden; 
    }
    
    #tapOverlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      color: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      z-index: 1000;
    }
    
    #tapOverlay button {
      padding: 15px 25px; 
      border: 0; 
      border-radius: 8px; 
      color: #fff; 
      background: #1976d2; 
      font-weight: bold; 
      font-size: 16px;
    }
    
    .hidden { 
      display: none !important; 
    }
  </style>

  <script id="matte-shader" type="x-shader/x-fragment">
    precision mediump float;
    uniform sampler2D videoColor;
    uniform sampler2D videoAlpha;
    uniform float opacity;
    varying vec2 vUV;
    
    void main() {
      vec4 color = texture2D(videoColor, vUV);
      float alpha = texture2D(videoAlpha, vUV).r * opacity;
      gl_FragColor = vec4(color.rgb, alpha);
    }
  </script>
</head>

<body>
  <div id="tapOverlay">
    <div>
      <div style="margin-bottom: 20px;">Tap to place AR content</div>
      <button id="startBtn">Start AR</button>
    </div>
  </div>

  <a-scene
    renderer="antialias: false; alpha: true"
    webxr="requiredFeatures: hit-test"
    vr-mode-ui="enabled: false"
    embedded
    style="height: 100vh; width: 100vw;"
  >
    <a-assets>
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             preload="auto" 
             loop 
             muted 
             crossorigin="anonymous" 
             playsinline>
      </video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             preload="auto" 
             loop 
             muted 
             crossorigin="anonymous" 
             playsinline>
      </video>
    </a-assets>

    <a-plane
      id="videoPlane"
      width="1.2"
      height="0.67"
      rotation="-90 0 0"
      material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; transparent: true"
      visible="false"
    ></a-plane>

    <a-camera></a-camera>
  </a-scene>

  <script>
    AFRAME.registerShader('video-matte', {
      schema: {
        videoColor: { type: 'map', is: 'uniform' },
        videoAlpha: { type: 'map', is: 'uniform' },
        opacity: { type: 'number', default: 1.0, is: 'uniform' }
      },
      fragmentShader: document.getElementById('matte-shader').textContent,
      vertexShader: `
        varying vec2 vUV;
        void main() {
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `
    });

    const tapOverlay = document.getElementById('tapOverlay');
    const startBtn = document.getElementById('startBtn');
    const videoPlane = document.getElementById('videoPlane');
    const videoColor = document.getElementById('videoColor');
    const videoAlpha = document.getElementById('videoAlpha');
    const scene = document.querySelector('a-scene');
    
    let placed = false;
    let hitTestSource = null;
    let refSpace = null;

    startBtn.addEventListener('click', function() {
      tapOverlay.classList.add('hidden');
    });

    // AR session events
    scene.renderer.xr.addEventListener('sessionstart', async function() {
      const session = scene.renderer.xr.getSession();
      refSpace = await session.requestReferenceSpace('local');
      const viewerSpace = await session.requestReferenceSpace('viewer');
      hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
    });

    scene.renderer.xr.addEventListener('sessionend', function() {
      placed = false;
      hitTestSource = null;
      refSpace = null;
      videoPlane.setAttribute('visible', false);
      videoColor.pause();
      videoAlpha.pause();
    });

    // Click to place
    window.addEventListener('click', function() {
      if (hitTestSource && !placed) {
        placed = true;
        videoPlane.setAttribute('visible', true);
        
        videoColor.muted = false;
        videoColor.volume = 0.8;
        videoColor.play();
        videoAlpha.play();
      }
    });

    // Hit test animation loop
    scene.renderer.setAnimationLoop(function(time, frame) {
      if (!frame || !hitTestSource || !refSpace || placed) return;

      const hitTestResults = frame.getHitTestResults(hitTestSource);
      if (hitTestResults.length > 0) {
        const hit = hitTestResults[0];
        const pose = hit.getPose(refSpace);
        
        if (pose) {
          const position = pose.transform.position;
          const orientation = pose.transform.orientation;
          
          videoPlane.object3D.position.set(position.x, position.y, position.z);
          videoPlane.object3D.quaternion.set(orientation.x, orientation.y, orientation.z, orientation.w);
        }
      }
    });
  </script>
</body>
</html>