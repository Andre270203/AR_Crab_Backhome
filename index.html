<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” AR.js Pinned (WebXR-like stability)</title>
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:transparent; }
    #soundOverlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; z-index:9999; }
    #soundOverlay button{ background:#1976d2; color:#fff; border:0; border-radius:10px; padding:12px 18px; font-weight:700; }
  </style>

  <!-- Minimal color+alpha matte shader -->
  <script>
    AFRAME.registerShader('video-matte', {
      schema: { videoColor:{type:'map',is:'uniform'}, videoAlpha:{type:'map',is:'uniform'}, opacity:{type:'number',default:1,is:'uniform'} },
      vertexShader: `
        varying vec2 vUV;
        void main(){ vUV=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }
      `,
      fragmentShader: `
        precision highp float;
        varying vec2 vUV;
        uniform sampler2D videoColor, videoAlpha;
        uniform float opacity;
        void main(){
          vec4 c=texture2D(videoColor,vUV);
          float a=texture2D(videoAlpha,vUV).r;
          a = smoothstep(0.15,0.95,a)*opacity;      /* crisper edges, less shimmer */
          gl_FragColor=vec4(c.rgb,a);
        }
      `
    });

    /**
     * pin-once: mimic WebXR "place once" stability
     * - Wait for markerFound
     * - Collect stable frames (low motion/rotation)
     * - Average pose, detach #target into scene, freeze matrix (no more updates)
     */
    AFRAME.registerComponent('pin-once', {
      schema:{
        target:{type:'selector'},
        samples:{type:'int', default:24},
        posEps:{type:'number', default:0.0007},   // meters/frame
        rotEpsDeg:{type:'number', default:0.2}    // degrees/frame
      },
      init:function(){
        this._collect=false; this._done=false; this._poses=[];
        this._lastPos=new THREE.Vector3(); this._lastQuat=new THREE.Quaternion();
        this._tmpPos=new THREE.Vector3(); this._tmpQuat=new THREE.Quaternion(); this._tmpScale=new THREE.Vector3();

        this.el.addEventListener('markerFound',()=>{ if(!this._done){ this._collect=true; this._poses.length=0; }});
        this.el.addEventListener('markerLost', ()=>{ if(!this._done){ this._collect=false; this._poses.length=0; }});
      },
      tick:function(){
        if(this._done||!this._collect) return;
        const obj=this.el.object3D; obj.updateMatrixWorld(true);
        obj.matrixWorld.decompose(this._tmpPos, this._tmpQuat, this._tmpScale);

        if(this._poses.length===0){ this._lastPos.copy(this._tmpPos); this._lastQuat.copy(this._tmpQuat); }

        const move=this._tmpPos.distanceTo(this._lastPos);
        const dot=Math.abs(THREE.MathUtils.clamp(this._lastQuat.dot(this._tmpQuat),-1,1));
        const ang=THREE.MathUtils.radToDeg(2*Math.acos(dot));

        if(move<=this.data.posEps && ang<=this.data.rotEpsDeg){
          this._poses.push({pos:this._tmpPos.clone(), quat:this._tmpQuat.clone()});
        } else {
          this._poses.length=0; // reset if jitter spikes
        }

        this._lastPos.copy(this._tmpPos); this._lastQuat.copy(this._tmpQuat);

        if(this._poses.length>=this.data.samples){
          // Average position
          const avgPos=new THREE.Vector3();
          for(const p of this._poses) avgPos.add(p.pos);
          avgPos.multiplyScalar(1/this._poses.length);
          // Average rotation (incremental slerp)
          let avgQuat=this._poses[0].quat.clone();
          for(let i=1;i<this._poses.length;i++) avgQuat.slerp(this._poses[i].quat, 1/(i+1));

          const t=this.data.target.object3D;
          // Detach from marker, attach to scene (world)
          this.el.sceneEl.object3D.attach(t);
          // Freeze transform
          t.matrixAutoUpdate=false;
          const S=new THREE.Vector3(1,1,1);
          const M=new THREE.Matrix4().compose(avgPos, avgQuat, S);
          t.matrix.copy(M); t.updateMatrixWorld(true);

          // Hide/disable marker anchor so it can't influence anything else
          this.el.setAttribute('visible', false);
          this._done=true; this._collect=false;
        }
      }
    });
  </script>
</head>

<body>
  <!-- One-tap audio unlock (required by mobile browsers) -->
  <div id="soundOverlay"><div style="text-align:center">
    <div style="margin-bottom:10px;font-size:18px">Tap to enable sound ðŸ”Š</div>
    <button id="soundBtn">Enable Audio</button>
  </div></div>

  <a-scene
    vr-mode-ui="enabled:false"
    embedded
    renderer="antialias:true; alpha:true; precision:medium"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled:false"
  >
    <a-assets>
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <!-- NFT marker: heavy smoothing only for the brief "collect" phase -->
    <a-nft
      type="nft"
      url="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/marker/AR_Image-tracker_Crab"
      smooth="true" smoothCount="60" smoothTolerance="0.005" smoothThreshold="5"
      pin-once="target:#pinned; samples:24; posEps:0.0007; rotEpsDeg:0.2"
    >
      <!-- Content starts under marker; gets detached & frozen after pin -->
      <a-entity id="pinned"
        geometry="primitive: plane; width: 1.2; height: 0.67"
        material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; transparent:true; depthWrite:false"
        position="0 0 0.1" rotation="-90 0 0">
      </a-entity>
    </a-nft>

    <!-- AR.js controls camera; keep look-controls off to avoid device sway -->
    <a-entity camera look-controls="enabled:false"></a-entity>
  </a-scene>

  <script>
    const overlay = document.getElementById('soundOverlay');
    const btn = document.getElementById('soundBtn');
    const vc = document.getElementById('videoColor');
    const va = document.getElementById('videoAlpha');

    // Start muted so autoplay works; visuals appear even before audio
    Promise.allSettled([vc.play(), va.play()]);

    // User gesture to enable sound (mobile policy requirement)
    btn.addEventListener('click', () => {
      vc.muted = false;
      vc.currentTime = 0; va.currentTime = 0;
      vc.play(); va.play();
      overlay.style.display = 'none';
    });
  </script>
</body>
</html>
