<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” Stabilized with Audio</title>

  <!-- A-Frame + AR.js (NFT) -->
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.6.0/dist/aframe-master.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; }
    #soundOverlay {
      position:absolute; inset:0;
      background:rgba(0,0,0,0.6);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:18px; font-family:sans-serif;
      z-index:9999;
    }
    #soundOverlay button {
      background:#4caf50; border:0; padding:12px 20px;
      border-radius:30px; color:#fff; font-size:16px; font-weight:bold;
    }
  </style>

  <script>
    // Minimal matte shader for color + alpha
    AFRAME.registerShader('video-matte', {
      schema: {
        videoColor: {type: 'map', is: 'uniform'},
        videoAlpha: {type: 'map', is: 'uniform'},
        opacity:    {type: 'number', default: 1.0, is: 'uniform'}
      },
      vertexShader: `
        varying vec2 vUV;
        void main(){
          vUV = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
        }
      `,
      fragmentShader: `
        precision highp float;
        varying vec2 vUV;
        uniform sampler2D videoColor;
        uniform sampler2D videoAlpha;
        uniform float opacity;
        void main(){
          vec4 c = texture2D(videoColor,vUV);
          float a = texture2D(videoAlpha,vUV).r;
          a = smoothstep(0.15,0.95,a) * opacity;
          gl_FragColor = vec4(c.rgb,a);
        }
      `
    });

    // Simple pin-once (average poses, then freeze in world)
    AFRAME.registerComponent('pin-once', {
      schema: { target:{type:'selector'}, samples:{default:20} },
      init:function(){
        this.poses=[]; this.done=false;
        this.el.addEventListener('markerFound',()=>{ if(!this.done) this.poses=[]; });
      },
      tick:function(){
        if(this.done||!this.el.object3D.visible) return;
        const obj=this.el.object3D; obj.updateMatrixWorld(true);
        this.poses.push(obj.matrixWorld.clone());
        if(this.poses.length>=this.data.samples){
          // Average only position; keep last rotation
          const avgPos=new THREE.Vector3();
          for(const m of this.poses){
            const p=new THREE.Vector3(); p.setFromMatrixPosition(m); avgPos.add(p);
          }
          avgPos.multiplyScalar(1/this.poses.length);
          const t=this.data.target.object3D;
          this.el.sceneEl.object3D.attach(t);
          t.position.copy(avgPos);
          t.quaternion.copy(obj.quaternion);
          t.updateMatrixWorld(true);
          t.matrixAutoUpdate=false;
          this.done=true;
        }
      }
    });
  </script>
</head>

<body>
  <!-- Overlay to unlock audio -->
  <div id="soundOverlay">
    <div>
      <p>Tap to enable sound ðŸ”Š</p>
      <button id="soundBtn">Enable Audio</button>
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="antialias: true; alpha:true"
    arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false"
  >
    <a-assets>
      <!-- Color video: start muted, will unmute on tap -->
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>

      <!-- Alpha video: stays muted -->
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-nft
      type="nft"
      url="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/marker/AR_Image-tracker_Crab"
      smooth="true" smoothCount="60" smoothTolerance="0.005" smoothThreshold="5"
      pin-once="target:#pinnedContent"
    >
      <a-entity id="pinnedContent"
        geometry="primitive: plane; width: 0.32; height: 0.20"
        material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; opacity:1.0; transparent:true"
        position="0 0 0.001" rotation="-90 0 0">
      </a-entity>
    </a-nft>

    <a-entity camera look-controls="enabled:false"></a-entity>
  </a-scene>

  <script>
    const btn=document.getElementById('soundBtn');
    const overlay=document.getElementById('soundOverlay');
    const vc=document.getElementById('videoColor');
    const va=document.getElementById('videoAlpha');

    // Start muted so autoplay works
    vc.play(); va.play();

    btn.addEventListener('click',()=>{
      vc.muted=false;   // unmute color video
      vc.currentTime=0; va.currentTime=0;
      vc.play(); va.play();
      overlay.style.display='none';
    });
  </script>
</body>
</html>
