<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” Fixed Version</title>
  
  <!-- A-Frame - using stable CDN -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  
  <style>
    html, body { 
      margin: 0; 
      height: 100%; 
      overflow: hidden; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    }
    
    #loader {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.85); 
      color: #fff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000;
      font-size: 18px;
    }
    
    #tapOverlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.7); 
      color: #fff; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      text-align: center; 
      z-index: 1001;
    }
    
    #tapOverlay button {
      margin-top: 20px; 
      padding: 15px 25px; 
      border: 0; 
      border-radius: 8px; 
      color: #fff; 
      background: #1976d2; 
      font-weight: bold; 
      font-size: 16px;
      cursor: pointer;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    a-scene {
      height: 100vh;
      width: 100vw;
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div id="loader">
    <div>Loading AR Experience...</div>
  </div>

  <!-- Audio unlock overlay -->
  <div id="tapOverlay">
    <div>
      <div style="font-size: 20px; margin-bottom: 10px;">AR Experience Ready</div>
      <div style="margin-bottom: 20px;">Tap to start and enable audio</div>
      <button id="tapBtn">Start AR</button>
    </div>
  </div>

  <a-scene
    renderer="antialias: true; precision: medium"
    webxr="requiredFeatures: hit-test; optionalFeatures: dom-overlay; overlayElement: #tapOverlay"
    vr-mode-ui="enabled: false"
    embedded
    background="color: transparent"
  >
    <a-assets>
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             preload="auto" 
             loop 
             muted 
             crossorigin="anonymous" 
             playsinline 
             webkit-playsinline>
      </video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             preload="auto" 
             loop 
             muted 
             crossorigin="anonymous" 
             playsinline 
             webkit-playsinline>
      </video>
    </a-assets>

    <!-- Simple plane for the video -->
    <a-plane
      id="videoPlane"
      width="1.2"
      height="0.67"
      position="0 0 -2"
      rotation="-90 0 0"
      material="src: #videoColor; transparent: true; alphaTest: 0.1"
      visible="false"
    ></a-plane>

    <a-camera wasd-controls="enabled: false"></a-camera>
  </a-scene>

  <script>
    console.log('Script starting...');
    
    // Wait for A-Frame to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded');
      
      const scene = document.querySelector('a-scene');
      const loader = document.getElementById('loader');
      const tapOverlay = document.getElementById('tapOverlay');
      const tapBtn = document.getElementById('tapBtn');
      const videoPlane = document.getElementById('videoPlane');
      const videoColor = document.getElementById('videoColor');
      const videoAlpha = document.getElementById('videoAlpha');
      
      let audioEnabled = false;
      let placed = false;
      
      // Hide loader when scene is ready
      function hideLoader() {
        console.log('Hiding loader');
        loader.classList.add('hidden');
        
        // Show tap overlay for mobile devices
        const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
          tapOverlay.style.display = 'flex';
        }
      }
      
      // Scene loaded handler
      if (scene.hasLoaded) {
        hideLoader();
      } else {
        scene.addEventListener('loaded', hideLoader);
      }
      
      // Enable audio and start AR
      function enableAudioAndStart() {
        console.log('Enabling audio and starting AR');
        audioEnabled = true;
        tapOverlay.classList.add('hidden');
        
        // Unmute videos
        videoColor.muted = false;
        videoColor.volume = 0.8;
        
        // Start playing videos
        videoColor.play().catch(e => console.warn('Video play failed:', e));
        videoAlpha.play().catch(e => console.warn('Alpha video play failed:', e));
        
        // Show video plane
        videoPlane.setAttribute('visible', true);
      }
      
      // Tap button handler
      tapBtn.addEventListener('click', enableAudioAndStart);
      
      // Simple hit-test component
      AFRAME.registerComponent('simple-hit-test', {
        init: function () {
          const el = this.el;
          const xr = el.sceneEl.renderer.xr;
          
          xr.addEventListener('sessionstart', async () => {
            console.log('XR session started');
            try {
              const session = xr.getSession();
              const refSpace = await session.requestReferenceSpace('local');
              const viewerSpace = await session.requestReferenceSpace('viewer');
              const hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
              
              // Simple placement on first tap
              const onTap = () => {
                if (!placed) {
                  placed = true;
                  console.log('Content placed');
                  enableAudioAndStart();
                }
              };
              
              window.addEventListener('click', onTap, { once: true });
              
              // Animation loop for hit testing
              el.sceneEl.renderer.setAnimationLoop((time, frame) => {
                if (!frame || !hitTestSource || placed) return;
                
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                  const hit = hitTestResults[0];
                  const pose = hit.getPose(refSpace);
                  
                  if (pose) {
                    const position = pose.transform.position;
                    const orientation = pose.transform.orientation;
                    
                    videoPlane.object3D.position.set(position.x, position.y, position.z);
                    videoPlane.object3D.quaternion.set(orientation.x, orientation.y, orientation.z, orientation.w);
                  }
                }
              });
              
            } catch (error) {
              console.error('Hit test setup failed:', error);
              // Fallback: show video plane at default position
              videoPlane.setAttribute('visible', true);
              enableAudioAndStart();
            }
          });
        }
      });
      
      // Add the component to the scene
      scene.setAttribute('simple-hit-test', '');
      
      console.log('Script setup complete');
    });
    
    // Error handling
    window.addEventListener('error', function(e) {
      console.error('JavaScript error:', e.error);
    });
    
    // Video error handling
    document.getElementById('videoColor').addEventListener('error', function(e) {
      console.error('Video loading error:', e);
    });
    
    document.getElementById('videoAlpha').addEventListener('error', function(e) {
      console.error('Alpha video loading error:', e);
    });
  </script>
</body>
</html>